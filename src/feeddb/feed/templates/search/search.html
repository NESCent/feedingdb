{% extends "admin/base.html" %}
{% load i18n %}
{% block bodyclass %}search{% endblock %}
{% load faceted_search_extras %}

{% block breadcrumbs %}
{% endblock %}

{% block pretitle %}
<div class="row">
  <h1>Search FEED</h1>
{% endblock %}

{% block content_title %}<p class="col-xs-10 col-xs-offset-1">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse quis ullamcorper velit. Praesent hendrerit mauris et luctus lacinia. Cras ac ornare quam, vitae vulputate libero. Nullam volutpat mauris tincidunt pretium lacinia. Phasellus posuere aliquam sem sit amet facilisis. Quisque placerat elit eu est adipiscing, a porttitor libero laoreet. Nunc posuere adipiscing mauris, sit amet tempus augue tincidunt ac. Duis porta arcu sed leo bibendum interdum. To access data contained within the XMA portal please click <a href="http://xmaportal.org">here</a>.</p></div>{% endblock %}

{% block content %}
<form method="post" action=".">
<div class="container">
{% csrf_token %}
<div class="row">
    <table class="search-box table col-xs-12">
      <!-- {{ form.as_table }} -->
      <tbody>
        <tr>
          <th class="col-xs-offset-1 col-xs-3 col-lg-offset-1 col-lg-2">
            <label for="id_q">Enter your search term(s):</label>
          </th>
          <td class="col-xs-6">
            {{ form.q }}
          </td>
          <td class="col-xs-2">
            <input type="submit" value="Submit">
          </td>
        </tr>
      </tbody>
    </table>
</div>
<div class="row">
  <div class="col-xs-12">
    <hr />
  </div>
</div>

{% if page or query %}

<div class="row">
  <div class="col-xs-3">
    <aside>
      <h3>Filter Results</h3>
      <p>Fields are optional. Multiple terms may be selected for each field.</p>
      {% show_facets facet_items 'taxon' %}
      {% show_facets facet_items 'behaviorowl_primary_ancestors' %}
      {% show_facets facet_items 'techniques' %}
      {% show_facets facet_items 'analoc' %}
      {% show_facets facet_items 'food_type' %}
    </aside>
  </div>
  <div class="col-xs-9">
    <div class="row">
      <div class="records-number col-xs-5 col-lg-4">
        <h3>Results ({{ page.paginator.count }})</h3>
      </div>
      <div class="records-list col-xs-7 col-lg-6 col-lg-offset-2">
        <p>Records to display:</p>
        {{ form.per_page }}
      </div>
    </div>
    <table class="table table-striped table-bordered">
      <tr>
        <th class="choose"><input type="checkbox" id="bucket_checkall" name="checkall" value="blank" /></th>
        <th class="column2">Trial Name<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column3">Start Date<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column4">Species<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column5" style="width:90px;">Primary<br />Behavior<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column6">Sensor Type<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column7">Anatomical<br />Location<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column8" style="width:102px;">Food Type<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
        <th class="column9" style="width:105px;">Collections<a class="glyphicon glyphicon-info-sign" href="#" data-toggle="tooltip" data-placement="top" title="Tooltip on top"></a></th>
      </tr>
      {% for result in page.object_list %}
        <tr>
          <td class="choose"><input type="checkbox" name="{{ result.object.id }}" value="on" /></td>
          <td class="column2"><a href="{% url 'trial_detail' result.object.id %}">{{ result.object.title }}</a></td>
          <td class="column3">{{ result.object.start | date:"M j, Y" | default:"unknown" }}</td>
          <td class="column4">{{ result.taxon }}</td>
          <td class="column5">{{ result.behaviorowl_primary }}</td>
          <td class="column6">
            {% for label in result.techniques %}
              {{ label }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
          <td class="column7">
            {% for label in result.analoc_direct %}
              {{ label }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
          <td class="column8">{{ result.object.food_type }}</td>
          <td class="column9">
            {% for bucket in result.object.bucket_set.all %}
              <a href="{% url 'explorer.views.bucket_detail' bucket.id %}">{{ bucket }}</a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
        </tr>
      {% empty %}
        <p>No results found.</p>
      {% endfor %}
    </table>
    <div class="row">
      <div class="records-selection col-xs-11 col-xs-offset-1 col-lg-9 col-lg-offset-1">
        <p>Add selected records to collection:</p>
        <select class="chosen-select" name="bucket">
          <option value=""> - Select - </option>
          {% for bucket in user.bucket_related.all %}
            <option value="{{bucket.id}}">{{bucket}}</option>
          {% endfor %}
          <option value="add new bucket">add new collection</option>
        </select>
        <input type="submit" name="put_bucket" value="Add to collection" class="btn btn-primary width-auto" />
        <div id="new_bucket_div">
          <noscript>If entering a new collection,</noscript>
          <div class="col-xs-8 new-bucket">
          <input name="new_bucket_name" size="20" placeholder="Enter new collection name" />
          </div>
        </div> 
      </div>
    </div>

  {% if page.has_previous or page.has_next %}
    <div class="row">
      <div class="records-pagination col-xs-3 col-xs-offset-4">
        {% if page.has_previous %}<a href="?{{ page.previous_page_params }}">{% endif %}&laquo; Previous{% if page.has_previous %}</a>{% endif %}
        |
        {% if page.has_next %}<a href="?{{ page.next_page_params }}">{% endif %}Next &raquo;{% if page.has_next %}</a>{% endif %}
      </div>
      <ul>
        {% comment %}
        How to list page links, kind of.
        {% for page_number in paginator.page_range %}
          <li><a href="?{{ paginator.first_page_params }}&amp;page={{page_number }}">{{ page_number }}</a></li>
        {% endfor %}
        {% endcomment %}
      </ul>
    </div>
  {% endif %}
  </div>
{% else %}
  {# Show some example queries to run, maybe query syntax, something else? #}
{% endif %}
</form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// TODO: add spinner graphiczzz!!
jQuery(document).on('ready', function() {
  $('form').find('.facet-group :input, #id_per_page :input').on('change', function() { this.form.submit(); });

  $('select[name=bucket]').on('change', function() {
    var show_bucket_name_field = (this.value == 'add new bucket');
    $('#new_bucket_div').toggle(show_bucket_name_field);
  }).change();

  $('#bucket_checkall').on('change', function() {
    $('.choose :checkbox').prop('checked', this.checked);
  });
});

</script>
{% endblock extra_js %}
