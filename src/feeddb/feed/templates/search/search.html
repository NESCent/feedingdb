{% extends "admin/base.html" %}
{% load i18n %}
{% block bodyclass %}search{% endblock %}
{% load faceted_search_extras %}

{% block pretitle %}
<div class="row">
  <h1>Search FEED</h1>
{% endblock %}

{% block content_title %}<p class="col-xs-10 col-xs-offset-1">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse quis ullamcorper velit. Praesent hendrerit mauris et luctus lacinia. Cras ac ornare quam, vitae vulputate libero. Nullam volutpat mauris tincidunt pretium lacinia. Phasellus posuere aliquam sem sit amet facilisis. Quisque placerat elit eu est adipiscing, a porttitor libero laoreet. Nunc posuere adipiscing mauris, sit amet tempus augue tincidunt ac. Duis porta arcu sed leo bibendum interdum. To access data contained within the XMA portal please click <a href="http://xmaportal.org">here</a>.</p></div>{% endblock %}

{% block content %}
<form method="post" action=".">
<div class="container">
{% csrf_token %}
<div class="row">
    <table class="search-box table col-xs-12">
      <!-- {{ form.as_table }} -->
      <tbody>
        <tr>
          <th class="col-xs-offset-1 col-xs-3 col-lg-offset-1 col-lg-2">
            <label for="id_q">Enter your search term(s):</label>
          </th>
          <td class="col-xs-6">
            {{ form.q }}
          </td>
          <td class="col-xs-2">
            <input type="submit" value="Submit">
          </td>
        </tr>
      </tbody>
    </table>
</div>
<div class="row">
  <div class="col-xs-12">
    <hr />
  </div>
</div>

{% if page or query %}

<div class="row">
  <div class="col-xs-3">
    <aside>
      <h3>Advanced Search</h3>
      {% show_facets facet_items 'taxon' %}
      {% show_facets facet_items 'muscles' %}
      {% show_facets facet_items 'muscles_part_of' %}
      {% show_facets facet_items 'techniques' %}
      {% show_facets facet_items 'food_type' %}
    </aside>
  </div>
  <div class="col-xs-9">
    <div class="row">
      <div class="records-number col-xs-5 col-lg-4">
        <h3>Results ({{ page.paginator.count }})</h3>
      </div>
      <div class="records-list col-xs-7 col-lg-6 col-lg-offset-2">
        <p>Records to display:</p>
        {{ form.per_page }}
      </div>
    </div>
    <table class="table table-striped table-bordered">
      <tr>
        <th class="choose"><input type="checkbox" id="bucket_checkall" name="checkall" value="blank" /></th>
        <th class="column2">Trial Name</th>
        <th class="column3">Date (start date)</th>
        <th class="column4">Species</th>
        <th class="column5">Primary<br />Behavior</th>
        <th class="column6">Techniques</th>
        <th class="column7">Anatomical<br />Location</th>
        <th class="column8">Food Type</th>
        <th class="column9">Collections</th>
      </tr>
      {% for result in page.object_list %}
        <tr>
          <td class="choose"><input type="checkbox" name="{{ result.object.id }}" value="on" /></td>
          <td class="column2"><a href="{% url 'trial_detail' result.object.id %}">{{ result.object.title }}</a></td>
          <td class="column3"><a href="">{{ result.object.start | date:"M j, Y" | default:"unknown" }}</a></td>
          <td class="column4"><a href="">{{ result.taxon }}</a></td>
          <td class="column5"><a href="">Mastication (FIXME)</a></td>
          <td class="column6">
            {% for label in result.techniques %}
              <a href="">{{ label }}</a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
          <td class="column7">
            {% for label in result.muscles_direct %}
              <a href="/{{ label }}">{{ label }}</a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
          <td class="column8"><a href="">{{ result.object.food_type }}</a></td>
          <td class="column9">
            {% for bucket in result.object.bucket_set.all %}
              <a href="">{{ bucket }}</a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
          </td>
        </tr>
      {% empty %}
        <p>No results found.</p>
      {% endfor %}
    </table>
    <div class="row">
      <div class="records-selection col-xs-10 col-xs-offset-1 col-lg-8 col-lg-offset-2">
        <p>Add selected records to collection:</p>
        <select class="chosen-select" name="bucket">
          <option value=""> - Select - </option>
          {% for bucket in user.bucket_related.all %}
            <option value="{{bucket.id}}">{{bucket}}</option>
          {% endfor %}
          <option value="add new bucket">add new bucket</option>
        </select>
        <input type="submit" name="put_bucket" value="Add to bucket" class="btn btn-primary" />
        <div id="new_bucket_div">
          <noscript>If entering a new bucket,</noscript>
          <div class="col-xs-8 new-bucket">
          <input name="new_bucket_name" size="20" placeholder="Enter new bucket name" />
          </div>
        </div> 
      </div>
    </div>

  {% if page.has_previous or page.has_next %}
    <div class="row">
      <div class="records-pagination col-xs-3 col-xs-offset-4">
        {% if page.has_previous %}<a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">{% endif %}&laquo; Previous{% if page.has_previous %}</a>{% endif %}
        |
        {% if page.has_next %}<a href="?q={{ query }}&amp;page={{ page.next_page_number }}">{% endif %}Next &raquo;{% if page.has_next %}</a>{% endif %}
      </div>
    </div>
  {% endif %}
  </div>
{% else %}
  {# Show some example queries to run, maybe query syntax, something else? #}
{% endif %}
</form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// TODO: add spinner graphiczzz!!
jQuery(document).on('ready', function() {
  $('form').find('.facet-group :input, #id_per_page :input').on('change', function() { this.form.submit(); });

  $('select[name=bucket]').on('change', function() {
    var show_bucket_name_field = (this.value == 'add new bucket');
    $('#new_bucket_div').toggle(show_bucket_name_field);
  }).change();

  $('#bucket_checkall').on('change', function() {
    $('.choose :checkbox').prop('checked', this.checked);
  });
});

</script>
{% endblock extra_js %}